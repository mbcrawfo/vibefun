# Parser Snapshot Tests - Task List

**Last Updated**: 2025-11-22
**Status**: ALL PHASES COMPLETE ✅ - Feature fully implemented and tested

## Phase 1: Setup and Infrastructure ✅

### Directory Structure
- [x] Create `packages/core/src/parser/snapshot-tests/` directory
- [x] Create `packages/core/src/parser/snapshot-tests/fixtures/` directory
- [x] Create `packages/core/src/parser/snapshot-tests/__snapshots__/` directory (will be auto-generated by vitest)

### Test Runner
- [x] Create `snapshot-tests.test.ts` with basic structure
- [x] Implement `parseSnapshot()` helper function to load and parse .vf files
- [x] Add test suite structure for all 8 categories
- [x] Verify test runner works with a simple fixture

## Phase 2: Create Fixture Files ✅

### 1. Declarations (declarations.vf)
- [x] Mutually recursive functions example
- [x] Mutually recursive types example
- [x] External block with types
- [x] Mixed exports and declarations
- [x] Pattern destructuring in let bindings
- [x] Generic type declarations
- [x] ~10 total realistic code samples

### 2. Expressions (expressions.vf)
- [x] Pipeline chains with lambdas
- [x] Nested operators across precedence levels
- [x] Complex type annotations
- [x] Record updates with computed fields
- [x] Nested match expressions
- [x] Composition operators
- [x] ~10 total realistic code samples

### 3. Patterns (patterns.vf)
- [x] Nested destructuring in match
- [x] Or-patterns with guards
- [x] List patterns with rest syntax
- [x] Record patterns with renaming
- [x] Tuple patterns
- [x] Complex pattern combinations
- [x] ~10 total realistic code samples

### 4. Functions (functions.vf)
- [x] Higher-order functions with generics
- [x] Currying and partial application
- [x] Recursive with pattern matching
- [x] Function composition examples
- [x] Type-annotated signatures
- [x] Lambda destructuring
- [x] ~10 total realistic code samples

### 5. Data Structures (data-structures.vf)
- [x] Deeply nested records
- [x] Multiple spread operators
- [x] Record updates with nesting
- [x] Lists with multiple spreads
- [x] Mixed literals and spreads
- [x] Trailing commas
- [x] ~10 total realistic code samples

### 6. Control Flow (control-flow.vf)
- [x] While loops with mutable refs
- [x] Nested if-match-block combinations
- [x] Blocks with multiple statements
- [x] Let expressions in blocks
- [x] Complex conditionals
- [x] ~10 total realistic code samples

### 7. Modules (modules.vf)
- [x] Complete module with imports
- [x] Export modifiers
- [x] Mixed declaration types
- [x] External declarations
- [x] Type definitions
- [x] Function exports
- [x] ~10 total realistic code samples

### 8. Real World (real-world.vf)
- [x] Option combinators (map, flatMap, etc.)
- [x] Result combinators
- [x] List operations (fold, map, filter)
- [x] Typical functional patterns
- [x] Well-typed generic functions
- [x] ~10 total realistic code samples

## Phase 3: Test Implementation ✅

### Add Tests for Each Category
- [x] Add test case for declarations.vf
- [x] Add test case for expressions.vf
- [x] Add test case for patterns.vf
- [x] Add test case for functions.vf
- [x] Add test case for data-structures.vf
- [x] Add test case for control-flow.vf
- [x] Add test case for modules.vf
- [x] Add test case for real-world.vf

### Generate Snapshots
- [x] Run `npm test` to generate initial snapshots
- [x] Review all generated snapshots for correctness
- [x] Verify AST structure matches expectations
- [x] Verify snapshots are formatted and readable

## Phase 4: Documentation ✅

### CLAUDE.md
- [x] Create CLAUDE.md in snapshot-tests directory
- [x] Add critical warning about reviewing before updating
- [x] Document snapshot update commands
- [x] Explain how to review AST diffs
- [x] Describe when to reject snapshot updates
- [x] Add guidelines for adding new tests
- [x] Include troubleshooting section

## Phase 5: Validation ✅

### Quality Checks
- [x] Run `npm run check` - Type checking passes
- [x] Run `npm run lint` - Linting passes
- [x] Run `npm test` - All tests pass including snapshots
- [x] Run `npm run format` - Code is formatted
- [x] Verify all .vf fixtures are valid vibefun syntax

### Coverage Review
- [x] Verify all major parser features are covered
- [x] Ensure realistic code patterns are tested
- [x] Check for appropriate edge cases
- [x] Validate test names are descriptive
- [x] Confirm snapshots are human-readable

### Documentation Review
- [x] CLAUDE.md is clear and complete
- [x] Update procedures are well-documented
- [x] Critical warnings are prominent
- [x] Examples are included where helpful

## Phase 6: Finalization ✅

### Integration
- [x] Verify snapshots are committed to git
- [x] Ensure tests run in CI pipeline
- [x] Update root CLAUDE.md if needed (folder structure only)
- [x] Verify tests fail when parser output changes

### Cleanup
- [x] Remove any temporary or debug files
- [x] Ensure consistent formatting across all files
- [x] Verify file organization is logical
- [x] Final review of all created files

## Progress Tracking

**Phases Completed**: 6/6 (100%) ✅ - ALL PHASES COMPLETE

## Additional Improvements Completed

### Test Organization Refactoring
- [x] Reorganized tests: one test file per fixture for better maintainability
- [x] Moved .vf files to be co-located with test files (removed fixtures/ subdirectory)
- [x] Each test generates its own snapshot file in __snapshots__/
- [x] Updated CLAUDE.md to reflect new structure

### Code Quality Improvements
- [x] Extracted parseFixture helper to test-helpers.ts
- [x] Eliminated code duplication across all test files
- [x] Improved test discoverability and organization

## Final Implementation Summary

**Total Tests Created**: 8 snapshot tests covering all major parser features
**Total Commits**: 3 commits
  1. Phase 2 complete - All fixture files and snapshots created
  2. Test reorganization - One test file per fixture
  3. Helper extraction - Reduced code duplication

**All Quality Checks Passing**: ✅
- Type checking: ✅
- Linting: ✅
- Tests (2628 total): ✅
- Formatting: ✅

## Notes

- Focus on realistic, idiomatic vibefun code in fixtures
- Each fixture should be self-contained and understandable
- Comments in .vf files should explain what's being tested
- Snapshots serve as documentation, so keep them clean
- Balance coverage with maintainability
- Reference language spec sections where relevant
